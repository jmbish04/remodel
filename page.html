import React, { useState, useRef, useEffect } from 'react';
import { Upload, ChevronRight, RefreshCw, Image as ImageIcon, Video, Layers, Wand2, Download, ArrowRight, CheckCircle, AlertCircle, X } from 'lucide-react';

const apiKey = ""; // Injected by environment

// --- Prompts from interior_design_v2.py ---
const PROMPTS = {
  step1: {
    title: "Generate 3D View",
    template: "Turn this technical 2D floorplan into a high-fidelity {perspective} 3D floorplan render. Style: {style}. Keep the exact layout, wall positions, and room dimensions identical to the source image. Extrude the walls and add flooring textures. Light the scene softly from the top-left.",
    defaults: { perspective: "isometric", style: "photorealistic modern" }
  },
  step2: {
    title: "Generate Interior View",
    template: "Using the provided 3D rendering as a layout guide, create a photorealistic interior photograph. The photo should be from a first-person perspective, as if a person is standing in the doorway looking into the {room_name}. Capture the sense of entering the room for the first time. Ensure the lighting and furniture placement are consistent with the 3D model.",
    defaults: { room_name: "Living Room" }
  },
  step3: {
    title: "Edit Design",
    template: "Using the provided image, {instruction}. Keep everything else in the image exactly the same, preserving the original lighting, perspective, and structural details.",
    defaults: { instruction: "Add a modern red leather sofa to the center" }
  },
  step4: {
    title: "Generate Video",
    template: "A slow, gentle panning shot of the room.",
    defaults: {}
  }
};

const App = () => {
  // State
  const [currentStep, setCurrentStep] = useState(0);
  const [library, setLibrary] = useState([]);
  const [selectedFloorplan, setSelectedFloorplan] = useState(null);
  
  // Pipeline State
  const [step1Result, setStep1Result] = useState(null); // 3D View
  const [step2Result, setStep2Result] = useState(null); // Interior View
  const [step3Result, setStep3Result] = useState(null); // Edited View
  const [step4Result, setStep4Result] = useState(null); // Video (Mock/Image)

  // Inputs
  const [params, setParams] = useState({
    perspective: PROMPTS.step1.defaults.perspective,
    style: PROMPTS.step1.defaults.style,
    room_name: PROMPTS.step2.defaults.room_name,
    instruction: PROMPTS.step3.defaults.instruction
  });

  const [isGenerating, setIsGenerating] = useState(false);
  const [error, setError] = useState(null);

  // --- API Helper ---
  const generateImage = async (prompt, sourceImageBase64) => {
    setIsGenerating(true);
    setError(null);

    try {
      // Clean base64 string
      const cleanBase64 = sourceImageBase64.replace(/^data:image\/(png|jpeg|jpg|webp);base64,/, "");

      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: prompt },
                {
                  inlineData: {
                    mimeType: "image/png",
                    data: cleanBase64
                  }
                }
              ]
            }],
            generationConfig: {
              responseModalities: ["IMAGE"] // Focusing on image output
            }
          })
        }
      );

      if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
      }

      const data = await response.json();
      
      // Extract Image
      const candidates = data.candidates;
      if (candidates && candidates.length > 0) {
        const parts = candidates[0].content.parts;
        const imagePart = parts.find(p => p.inlineData);
        if (imagePart) {
          return `data:image/png;base64,${imagePart.inlineData.data}`;
        }
      }
      throw new Error("No image generated");

    } catch (err) {
      setError(err.message);
      return null;
    } finally {
      setIsGenerating(false);
    }
  };

  // --- Handlers ---

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const newItem = {
          id: Date.now(),
          name: file.name,
          src: event.target.result
        };
        setLibrary(prev => [...prev, newItem]);
        if (!selectedFloorplan) setSelectedFloorplan(newItem);
      };
      reader.readAsDataURL(file);
    }
  };

  const executeStep1 = async () => {
    if (!selectedFloorplan) return;
    const prompt = PROMPTS.step1.template
      .replace("{perspective}", params.perspective)
      .replace("{style}", params.style);
    
    const result = await generateImage(prompt, selectedFloorplan.src);
    if (result) {
      setStep1Result(result);
      setCurrentStep(1); // Advance
    }
  };

  const executeStep2 = async () => {
    if (!step1Result) return;
    const prompt = PROMPTS.step2.template
      .replace("{room_name}", params.room_name);
    
    const result = await generateImage(prompt, step1Result);
    if (result) {
      setStep2Result(result);
      setCurrentStep(2); // Advance
    }
  };

  const executeStep3 = async () => {
    if (!step2Result) return;
    const prompt = PROMPTS.step3.template
      .replace("{instruction}", params.instruction);
    
    const result = await generateImage(prompt, step2Result);
    if (result) {
      setStep3Result(result);
      setCurrentStep(3); // Advance
    }
  };

  const executeStep4 = async () => {
    // Note: Since actual Veo video generation isn't available in this specific standard API endpoint yet
    // without specific whitelisting, we will generate a "Cinematic Frame" using the video prompt
    // to simulate the start of the video.
    if (!step3Result && !step2Result) return;
    const source = step3Result || step2Result;
    
    // We modify the prompt slightly to make it an image generation task that LOOKS like a video still
    const prompt = `Cinematic still frame: ${PROMPTS.step4.template} High motion blur, 4k.`;
    
    const result = await generateImage(prompt, source);
    if (result) {
      setStep4Result(result);
    }
  };

  const handleParamChange = (key, value) => {
    setParams(prev => ({ ...prev, [key]: value }));
  };

  // --- UI Components ---

  const StepIndicator = () => (
    <div className="flex items-center justify-between mb-8 px-4">
      {['Upload', '3D Model', 'Interior', 'Edit', 'Video'].map((label, idx) => (
        <div key={label} className={`flex flex-col items-center cursor-pointer ${idx <= currentStep ? 'opacity-100' : 'opacity-40'}`} onClick={() => idx <= currentStep && setCurrentStep(idx)}>
          <div className={`w-8 h-8 rounded-full flex items-center justify-center mb-2 font-bold text-sm transition-colors ${idx === currentStep ? 'bg-blue-600 text-white' : idx < currentStep ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'}`}>
            {idx < currentStep ? <CheckCircle size={16} /> : idx + 1}
          </div>
          <span className="text-xs font-medium text-gray-600">{label}</span>
        </div>
      ))}
    </div>
  );

  const PreviewImage = ({ src, label, onDownload }) => (
    <div className="relative group bg-gray-100 rounded-lg overflow-hidden border border-gray-200 shadow-sm aspect-video flex items-center justify-center">
      {src ? (
        <>
          <img src={src} alt={label} className="w-full h-full object-cover" />
          <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors" />
          {onDownload && (
            <button onClick={onDownload} className="absolute top-2 right-2 p-2 bg-white/90 rounded-full shadow-sm opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white">
              <Download size={16} className="text-gray-700" />
            </button>
          )}
        </>
      ) : (
        <div className="text-gray-400 flex flex-col items-center">
          <ImageIcon size={32} className="mb-2 opacity-50" />
          <span className="text-sm">Waiting for generation...</span>
        </div>
      )}
      <div className="absolute bottom-0 left-0 right-0 bg-white/90 backdrop-blur-sm px-3 py-1 text-xs font-semibold text-gray-700 border-t border-gray-100">
        {label}
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50 text-gray-800 font-sans selection:bg-blue-100">
      <div className="max-w-5xl mx-auto p-6">
        
        {/* Header */}
        <header className="flex items-center justify-between mb-8">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-blue-600 rounded-lg text-white shadow-lg shadow-blue-600/20">
              <Layers size={24} />
            </div>
            <div>
              <h1 className="text-2xl font-bold tracking-tight text-gray-900">Interior Design Studio</h1>
              <p className="text-sm text-gray-500">Pipeline: Floorplan → 3D → Interior → Edit → Video</p>
            </div>
          </div>
          <div className="text-xs bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full border border-yellow-200">
             ⚡ Powered by Gemini 2.5 Flash
          </div>
        </header>

        <StepIndicator />

        {/* Error Banner */}
        {error && (
          <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3 text-red-700 animate-in fade-in slide-in-from-top-2">
            <AlertCircle size={20} className="mt-0.5 flex-shrink-0" />
            <div className="flex-1">
              <h4 className="font-semibold text-sm">Generation Failed</h4>
              <p className="text-sm opacity-90">{error}</p>
            </div>
            <button onClick={() => setError(null)}><X size={16} /></button>
          </div>
        )}

        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
          
          {/* LEFT PANEL: Controls */}
          <div className="lg:col-span-4 space-y-6">
            
            {/* Step 0: Upload */}
            <div className={`p-5 rounded-xl border transition-all duration-300 ${currentStep === 0 ? 'bg-white border-blue-200 shadow-md ring-1 ring-blue-100' : 'bg-gray-50 border-gray-200 opacity-60'}`}>
              <div className="flex items-center gap-2 mb-4">
                <div className="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-xs font-bold">1</div>
                <h3 className="font-semibold text-gray-800">Source Floorplan</h3>
              </div>
              
              {selectedFloorplan ? (
                <div className="space-y-3">
                  <div className="relative rounded-lg overflow-hidden border border-gray-200">
                    <img src={selectedFloorplan.src} alt="Selected" className="w-full h-40 object-cover" />
                    <button 
                      onClick={() => setSelectedFloorplan(null)} 
                      className="absolute top-2 right-2 bg-white/90 p-1 rounded-full text-gray-600 hover:text-red-600 hover:bg-white transition-colors"
                    >
                      <RefreshCw size={14} />
                    </button>
                  </div>
                  <div className="text-xs text-center text-gray-500 truncate">{selectedFloorplan.name}</div>
                  
                  {currentStep === 0 && (
                     <button 
                      onClick={() => setCurrentStep(1)}
                      className="w-full mt-2 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 text-sm font-medium"
                    >
                      Use this Floorplan <ChevronRight size={16} />
                    </button>
                  )}
                </div>
              ) : (
                <label className="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors group">
                  <div className="flex flex-col items-center justify-center pt-5 pb-6">
                    <Upload className="w-8 h-8 mb-3 text-gray-400 group-hover:text-blue-500 transition-colors" />
                    <p className="mb-1 text-sm text-gray-500">Click to upload floorplan</p>
                    <p className="text-xs text-gray-400">JPG, PNG (Max 5MB)</p>
                  </div>
                  <input type="file" className="hidden" accept="image/*" onChange={handleFileUpload} />
                </label>
              )}
            </div>

            {/* Step 1: 3D Config */}
            <div className={`p-5 rounded-xl border transition-all duration-300 ${currentStep === 1 ? 'bg-white border-blue-200 shadow-md ring-1 ring-blue-100' : 'bg-gray-50 border-gray-200 opacity-60'}`}>
              <div className="flex items-center gap-2 mb-4">
                <div className="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-xs font-bold">2</div>
                <h3 className="font-semibold text-gray-800">Generate 3D Model</h3>
              </div>
              
              <div className="space-y-3">
                <div>
                  <label className="text-xs font-medium text-gray-500 block mb-1">Perspective</label>
                  <select 
                    value={params.perspective}
                    onChange={(e) => handleParamChange('perspective', e.target.value)}
                    disabled={currentStep !== 1}
                    className="w-full text-sm bg-gray-50 border border-gray-200 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                  >
                    <option value="isometric">Isometric</option>
                    <option value="top-down">Top-Down</option>
                  </select>
                </div>
                <div>
                  <label className="text-xs font-medium text-gray-500 block mb-1">Style</label>
                  <input 
                    type="text" 
                    value={params.style}
                    onChange={(e) => handleParamChange('style', e.target.value)}
                    disabled={currentStep !== 1}
                    className="w-full text-sm bg-gray-50 border border-gray-200 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                  />
                </div>
                {currentStep === 1 && (
                  <button 
                    onClick={executeStep1} 
                    disabled={isGenerating}
                    className="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-blue-300 transition-colors flex items-center justify-center gap-2 text-sm font-medium mt-2"
                  >
                    {isGenerating ? <RefreshCw className="animate-spin" size={16} /> : <Wand2 size={16} />}
                    Generate 3D
                  </button>
                )}
              </div>
            </div>

            {/* Step 2: Interior Config */}
            <div className={`p-5 rounded-xl border transition-all duration-300 ${currentStep === 2 ? 'bg-white border-blue-200 shadow-md ring-1 ring-blue-100' : 'bg-gray-50 border-gray-200 opacity-60'}`}>
              <div className="flex items-center gap-2 mb-4">
                <div className="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-xs font-bold">3</div>
                <h3 className="font-semibold text-gray-800">Interior View</h3>
              </div>
              
              <div className="space-y-3">
                <div>
                  <label className="text-xs font-medium text-gray-500 block mb-1">Room to Zoom</label>
                  <input 
                    type="text" 
                    value={params.room_name}
                    onChange={(e) => handleParamChange('room_name', e.target.value)}
                    disabled={currentStep !== 2}
                    className="w-full text-sm bg-gray-50 border border-gray-200 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                  />
                </div>
                {currentStep === 2 && (
                  <button 
                    onClick={executeStep2} 
                    disabled={isGenerating}
                    className="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-blue-300 transition-colors flex items-center justify-center gap-2 text-sm font-medium mt-2"
                  >
                    {isGenerating ? <RefreshCw className="animate-spin" size={16} /> : <Wand2 size={16} />}
                    Enter Room
                  </button>
                )}
              </div>
            </div>

            {/* Step 3: Edit Config */}
            <div className={`p-5 rounded-xl border transition-all duration-300 ${currentStep === 3 ? 'bg-white border-blue-200 shadow-md ring-1 ring-blue-100' : 'bg-gray-50 border-gray-200 opacity-60'}`}>
              <div className="flex items-center gap-2 mb-4">
                <div className="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-xs font-bold">4</div>
                <h3 className="font-semibold text-gray-800">Refine Design</h3>
              </div>
              
              <div className="space-y-3">
                <div>
                  <label className="text-xs font-medium text-gray-500 block mb-1">Instruction</label>
                  <textarea 
                    value={params.instruction}
                    onChange={(e) => handleParamChange('instruction', e.target.value)}
                    disabled={currentStep !== 3}
                    className="w-full text-sm bg-gray-50 border border-gray-200 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none min-h-[80px]"
                  />
                </div>
                {currentStep === 3 && (
                  <div className="flex gap-2">
                     <button 
                      onClick={executeStep3} 
                      disabled={isGenerating}
                      className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-blue-300 transition-colors flex items-center justify-center gap-2 text-sm font-medium"
                    >
                      {isGenerating ? <RefreshCw className="animate-spin" size={16} /> : <Wand2 size={16} />}
                      Apply Edit
                    </button>
                     <button 
                      onClick={() => setCurrentStep(4)} 
                      className="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium"
                    >
                      Skip
                    </button>
                  </div>
                 
                )}
              </div>
            </div>

             {/* Step 4: Video */}
             <div className={`p-5 rounded-xl border transition-all duration-300 ${currentStep === 4 ? 'bg-white border-blue-200 shadow-md ring-1 ring-blue-100' : 'bg-gray-50 border-gray-200 opacity-60'}`}>
              <div className="flex items-center gap-2 mb-4">
                <div className="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-xs font-bold">5</div>
                <h3 className="font-semibold text-gray-800">Generate Video</h3>
              </div>
              {currentStep === 4 && (
                 <button 
                 onClick={executeStep4} 
                 disabled={isGenerating}
                 className="w-full py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-purple-300 transition-colors flex items-center justify-center gap-2 text-sm font-medium"
               >
                 {isGenerating ? <RefreshCw className="animate-spin" size={16} /> : <Video size={16} />}
                 Render Clip
               </button>
              )}
            </div>

          </div>

          {/* RIGHT PANEL: Results */}
          <div className="lg:col-span-8 space-y-6">
            
            <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 min-h-[600px]">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-lg font-bold text-gray-900">Project Gallery</h2>
                {isGenerating && (
                  <div className="flex items-center gap-2 text-sm text-blue-600 animate-pulse">
                    <Wand2 size={16} />
                    <span>Processing request...</span>
                  </div>
                )}
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-2">
                   <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider">Original</h4>
                   <PreviewImage src={selectedFloorplan?.src} label="Floorplan" />
                </div>

                <div className="space-y-2">
                   <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider">Step 1: 3D Render</h4>
                   <PreviewImage src={step1Result} label="3D View" onDownload={step1Result ? () => {} : null} />
                   {step1Result && currentStep > 1 && (
                     <p className="text-xs text-gray-500 italic border-l-2 border-gray-300 pl-2">
                       Prompt: {PROMPTS.step1.template.replace("{perspective}", params.perspective).replace("{style}", params.style).substring(0, 60)}...
                     </p>
                   )}
                </div>

                <div className="space-y-2">
                   <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider">Step 2: Interior Zoom</h4>
                   <PreviewImage src={step2Result} label="Interior View" onDownload={step2Result ? () => {} : null} />
                </div>

                <div className="space-y-2">
                   <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider">Step 3: Refined Design</h4>
                   <PreviewImage src={step3Result} label="Edited View" onDownload={step3Result ? () => {} : null} />
                   {step3Result && (
                      <p className="text-xs text-gray-500 italic border-l-2 border-gray-300 pl-2">
                      Instruction: {params.instruction}
                    </p>
                   )}
                </div>
              </div>

              {/* Video Section Large */}
              <div className="mt-8 pt-8 border-t border-gray-100">
                <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Step 4: Final Video Output</h4>
                <div className="relative bg-gray-900 rounded-xl overflow-hidden aspect-[21/9] flex items-center justify-center group">
                   {step4Result ? (
                     <>
                      <img src={step4Result} alt="Video Frame" className="w-full h-full object-cover opacity-80" />
                      <div className="absolute inset-0 flex items-center justify-center">
                        <div className="w-16 h-16 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center cursor-pointer hover:scale-110 transition-transform">
                          <div className="w-0 h-0 border-t-[10px] border-t-transparent border-l-[18px] border-l-white border-b-[10px] border-b-transparent ml-1"></div>
                        </div>
                      </div>
                     </>
                   ) : (
                     <div className="text-gray-600 flex flex-col items-center">
                       <Video size={48} className="mb-3 opacity-30" />
                       <span className="text-sm">Video not generated</span>
                     </div>
                   )}
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;
